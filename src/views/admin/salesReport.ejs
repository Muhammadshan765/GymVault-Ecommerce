<%- include('../partials/sidebar') %>
    <link rel="stylesheet" href="/tailwindcss/output.css" />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" />
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet" />
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

<div class="p-8 flex-1 bg-gradient-to-br from-gray-50 to-gray-100 min-h-screen">
    <div class="max-w-7xl mx-auto">
        <!-- Header Section with Download Buttons -->
        <div class="flex justify-between items-center mb-8">
            <div>
                <h1 class="text-3xl font-bold text-gray-900 mb-2">Sales Report</h1>
                <p class="text-gray-600">Track and analyze your business performance</p>
            </div>
            <div class="flex gap-4">
                <button onclick="downloadReport('excel')" 
                        class="flex items-center px-6 py-3 bg-emerald-600 text-white rounded-xl hover:bg-emerald-700 transition-all duration-300 shadow-sm hover:shadow-md transform hover:-translate-y-0.5">
                    <i class="fas fa-file-excel mr-2"></i>Download Excel
                </button>
                <button onclick="downloadReport('pdf')" 
                        class="flex items-center px-6 py-3 bg-red-600 text-white rounded-xl hover:bg-red-700 transition-all duration-300 shadow-sm hover:shadow-md transform hover:-translate-y-0.5">
                    <i class="fas fa-file-pdf mr-2"></i>Download PDF
                </button>
            </div>
        </div>

        <!-- Filter Section -->
        <div class="bg-white rounded-2xl shadow-sm p-6 mb-8">
            <div class="flex flex-wrap gap-4 mb-6">
                <button onclick="setPeriod('daily')" 
                        class="px-6 py-3 rounded-xl transition-all duration-300 <%= period === 'daily' ? 'bg-black text-white shadow-lg transform scale-105' : 'bg-gray-100 hover:bg-gray-200 hover:shadow' %>">
                    <i class="far fa-calendar-day mr-2"></i>Daily
                </button>
                <button onclick="setPeriod('weekly')"
                        class="px-6 py-3 rounded-xl transition-all duration-300 <%= period === 'weekly' ? 'bg-black text-white shadow-lg transform scale-105' : 'bg-gray-100 hover:bg-gray-200 hover:shadow' %>">
                    <i class="far fa-calendar-week mr-2"></i>Weekly
                </button>
                <button onclick="setPeriod('monthly')"
                        class="px-6 py-3 rounded-xl transition-all duration-300 <%= period === 'monthly' ? 'bg-black text-white shadow-lg transform scale-105' : 'bg-gray-100 hover:bg-gray-200 hover:shadow' %>">
                    <i class="far fa-calendar-alt mr-2"></i>Monthly
                </button>
                <button onclick="setPeriod('yearly')"
                        class="px-6 py-3 rounded-xl transition-all duration-300 <%= period === 'yearly' ? 'bg-black text-white shadow-lg transform scale-105' : 'bg-gray-100 hover:bg-gray-200 hover:shadow' %>">
                    <i class="far fa-calendar mr-2"></i>Yearly
                </button>
            </div>
            <div class="flex flex-wrap gap-6 items-end">
                <div class="flex-1 min-w-[200px]">
                    <label class="block text-sm font-medium text-gray-700 mb-2">Start Date</label>
                    <input type="date" id="startDate" class="w-full px-4 py-3 border border-gray-200 rounded-xl focus:ring-2 focus:ring-black focus:border-transparent transition-all" 
                           value="<%= dateRange.start?.toISOString().split('T')[0] %>">
                </div>
                <div class="flex-1 min-w-[200px]">
                    <label class="block text-sm font-medium text-gray-700 mb-2">End Date</label>
                    <input type="date" id="endDate" class="w-full px-4 py-3 border border-gray-200 rounded-xl focus:ring-2 focus:ring-black focus:border-transparent transition-all"
                           value="<%= dateRange.end?.toISOString().split('T')[0] %>">
                </div>
                <button onclick="applyDateFilter()" 
                        class="px-8 py-3 bg-blue-700 text-white rounded-xl hover:bg-blue-800 transition-all duration-300 shadow-sm hover:shadow-md transform hover:-translate-y-0.5">
                    <i class="fas fa-filter mr-2"></i>Apply Filter
                </button>
            </div>
        </div>

        <!-- Rest of the code remains the same as the previous version -->
        <!-- Metrics Section -->
        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6 mb-8">
            <!-- Same metrics cards as before -->
            <div class="bg-white p-6 rounded-2xl shadow-sm hover:shadow-md transition-all duration-300 transform hover:-translate-y-1">
                <div class="flex items-center justify-between mb-4">
                    <h3 class="text-gray-600 font-medium">Total Orders</h3>
                    <div class="p-3 bg-blue-50 rounded-xl">
                        <i class="fas fa-shopping-cart text-blue-500"></i>
                    </div>
                </div>
                <p class="text-4xl font-bold text-gray-900"><%= metrics.totalOrders %></p>
                <p class="text-sm text-gray-500 mt-2">All time orders</p>
            </div>
            <div class="bg-white p-6 rounded-2xl shadow-sm hover:shadow-md transition-all duration-300 transform hover:-translate-y-1">
                <div class="flex items-center justify-between mb-4">
                    <h3 class="text-gray-600 font-medium">Total Sales</h3>
                    <div class="p-3 bg-green-50 rounded-xl">
                        <i class="fas fa-rupee-sign text-green-500"></i>
                    </div>
                </div>
                <p class="text-4xl font-bold text-gray-900">₹<%= metrics.totalSales.toFixed(2) %></p>
                <p class="text-sm text-gray-500 mt-2">Gross revenue</p>
            </div>
            <div class="bg-white p-6 rounded-2xl shadow-sm hover:shadow-md transition-all duration-300 transform hover:-translate-y-1">
                <div class="flex items-center justify-between mb-4">
                    <h3 class="text-gray-600 font-medium">Total Discount</h3>
                    <div class="p-3 bg-purple-50 rounded-xl">
                        <i class="fas fa-tags text-purple-500"></i>
                    </div>
                </div>
                <p class="text-4xl font-bold text-gray-900">₹<%= metrics.totalDiscount.toFixed(2) %></p>
                
                <p class="text-sm text-gray-500 mt-2">Total savings offered</p>
            </div>
            <div class="bg-white p-6 rounded-2xl shadow-sm hover:shadow-md transition-all duration-300 transform hover:-translate-y-1">
                <div class="flex items-center justify-between mb-4">
                    <h3 class="text-gray-600 font-medium">Average Order</h3>
                    <div class="p-3 bg-orange-50 rounded-xl">
                        <i class="fas fa-chart-line text-orange-500"></i>
                    </div>
                </div>
                <p class="text-4xl font-bold text-gray-900">₹<%= metrics.averageOrderValue.toFixed(2) %></p>
                <p class="text-sm text-gray-500 mt-2">Per order average</p>
            </div>
        </div>

        <!-- Orders Table -->
        <!-- Same table structure as before -->
        <div class="bg-white rounded-2xl shadow-sm overflow-hidden">
            <div class="overflow-x-auto">
                <table class="min-w-full divide-y divide-gray-200">
                    <!-- Same table content as before -->
                    <thead>
                        <tr class="bg-gray-50">
                            <th class="px-6 py-4 text-left text-xs font-semibold text-gray-600 uppercase tracking-wider">Order ID</th>
                            <th class="px-6 py-4 text-left text-xs font-semibold text-gray-600 uppercase tracking-wider">Date</th>
                            <th class="px-6 py-4 text-left text-xs font-semibold text-gray-600 uppercase tracking-wider">Customer</th>
                            <th class="px-6 py-4 text-left text-xs font-semibold text-gray-600 uppercase tracking-wider">Items</th>
                            <th class="px-6 py-4 text-left text-xs font-semibold text-gray-600 uppercase tracking-wider">Status</th>
                            <th class="px-6 py-4 text-left text-xs font-semibold text-gray-600 uppercase tracking-wider">Payment Method</th>
                            <th class="px-6 py-4 text-left text-xs font-semibold text-gray-600 uppercase tracking-wider">Amount</th>
                        </tr>
                    </thead>
                    <tbody class="bg-white divide-y divide-gray-200">
                        <% orders.forEach(order => { %>
                            <!-- Same row structure as before -->
                            <tr class="hover:bg-gray-50 transition-colors">
                                <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900">
                                    <%= order.orderCode %>
                                </td>
                                <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-600">
                                    <%= order.createdAt.toLocaleDateString() %>
                                </td>
                                <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">
                                    <%= order.userId?.firstName %> <%= order.userId?.lastName %>
                                </td>
                                <td class="px-6 py-4 text-sm text-gray-600">
                                    <% order.items.forEach((item, index) => { %>
                                        <div class="<%= index > 0 ? 'mt-2' : '' %>">
                                            <%= item.quantity %>x <%= item.product.name %>
                                        </div>
                                    <% }); %>
                                </td>
                                <td class="px-6 py-4 whitespace-nowrap">
                                    <% order.items.forEach((item, index) => { %>
                                        <% const status = item.order.status;
                                        const statusColor = {
                                            'delivered': 'bg-green-100 text-green-800',
                                            'cancelled': 'bg-red-100 text-red-800',
                                            'returned': 'bg-gray-100 text-gray-800',
                                            'refund processing': 'bg-yellow-100 text-yellow-800',
                                            'pending': 'bg-blue-100 text-blue-800',
                                            'processing': 'bg-indigo-100 text-indigo-800',
                                            'shipped': 'bg-purple-100 text-purple-800'
                                        }[status] || 'bg-gray-100 text-gray-800'; %>
                                        <span class="<%= index > 0 ? 'mt-2' : '' %> px-3 py-1 inline-flex text-xs leading-5 font-semibold rounded-full <%= statusColor %>">
                                            <%= status %>
                                        </span>
                                    <% }); %>
                                </td>
                                <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-600">
                                    <%= order.payment.method %>
                                    <% const paymentStatus = order.payment.paymentStatus;
                                    const paymentStatusColor = {
                                        'completed': 'bg-green-100 text-green-800',
                                        'failed': 'bg-red-100 text-red-800',
                                        'processing': 'bg-yellow-100 text-yellow-800',
                                        'refunded': 'bg-gray-100 text-gray-800',
                                        'cancelled': 'bg-red-100 text-red-800',
                                        'refund processing': 'bg-yellow-100 text-yellow-800'
                                    }[paymentStatus] || 'bg-gray-100 text-gray-800'; %>
                                </td>
                                <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900">
                                    ₹<%= order.totalAmount.toFixed(2) %>
                                </td>
                            </tr>
                        <% }); %>
                    </tbody>
                </table>
            </div>
        </div>
    </div>
</div>

<!-- Same scripts as before -->
<script>
    // Initialize Chart
    const ctx = document.getElementById('salesChart').getContext('2d');
    const dailyData = <%- JSON.stringify(dailyData) %>;
    
    const dates = Object.keys(dailyData);
    const sales = dates.map(date => {
        const dayData = dailyData[date];
        return {
            orders: dayData.orders,
            sales: dayData.sales,
            discount: dayData.discount,
            netRevenue: dayData.netRevenue
        };
    });
    
    new Chart(ctx, {
        type: 'line',
        data: {
            labels: dates,
            datasets: [{
                label: 'Daily Sales',
                data: sales,
                borderColor: 'rgb(0, 0, 0)',
                tension: 0.1
            }]
        },
        options: {
            responsive: true,
            scales: {
                y: {
                    beginAtZero: true
                }
            }
        }
    });

    // Filter Functions
    function setPeriod(period) {
        window.location.href = `/admin/sales-report?period=${period}`;
    }

    async function applyDateFilter() {
        try {
            const startDateStr = document.getElementById('startDate').value;
            const endDateStr = document.getElementById('endDate').value;
            
            const startDate = new Date(startDateStr);
            startDate.setHours(0, 0, 0, 0);
            
            const endDate = new Date(endDateStr);
            endDate.setHours(23, 59, 59, 999);
            
            const today = new Date();
            today.setHours(23, 59, 59, 999);

            if (!startDateStr || !endDateStr) {
                await Swal.fire({
                    icon: 'warning',
                    title: 'Missing Dates',
                    text: 'Please select both start and end dates',
                    confirmButtonColor: '#000000'
                });
                return;
            }

            if (startDate > today) {
                await Swal.fire({
                    icon: 'error',
                    title: 'Invalid Date',
                    text: 'Start date cannot be in the future',
                    confirmButtonColor: '#000000'
                });
                return;
            }

            if (endDate < startDate) {
                await Swal.fire({
                    icon: 'error',
                    title: 'Invalid Date Range',
                    text: 'End date must be after or equal to start date',
                    confirmButtonColor: '#000000'
                });
                return;
            }

            window.location.href = `/admin/sales-report?startDate=${startDateStr}&endDate=${endDateStr}`;

        } catch (error) {
            await Swal.fire({
                icon: 'error',
                title: 'Error',
                text: error.message || 'Error applying filter',
                confirmButtonColor: '#000000'
            });
        }
    }

    // Download Functions
    async function downloadReport(type) {
        try {
            const startDateStr = document.getElementById('startDate').value;
            const endDateStr = document.getElementById('endDate').value;
            
            if (!startDateStr || !endDateStr) {
                await Swal.fire({
                    icon: 'warning',
                    title: 'Missing Dates',
                    text: 'Please select both start and end dates',
                    confirmButtonColor: '#000000'
                });
                return;
            }

            Swal.fire({
                title: 'Generating report...',
                allowOutsideClick: false,
                didOpen: () => {
                    Swal.showLoading();
                }
            });

            const response = await fetch(`/admin/sales-report/download-${type}?startDate=${startDateStr}&endDate=${endDateStr}`);
            
            if (!response.ok) {
                throw new Error(`Download failed with status: ${response.status}`);
            }

            if (type === 'excel') {
                const blob = await response.blob();
                const url = window.URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `sales-report-${startDateStr}-to-${endDateStr}.xlsx`;
                document.body.appendChild(a);
                a.click();
                window.URL.revokeObjectURL(url);
                a.remove();
            } 
            else if (type === 'pdf') {
                const blob = await response.blob();
                const url = window.URL.createObjectURL(blob);
                window.open(url, '_blank');
                window.URL.revokeObjectURL(url);
            }

            Swal.close();

            await Swal.fire({
                icon: 'success',
                title: 'Success',
                text: `Report downloaded successfully!`,
                confirmButtonColor: '#000000'
            });

        } catch (error) {
            console.error('Download error:', error);
            await Swal.fire({
                icon: 'error',
                title: 'Download Failed',
                text: error.message || 'Error downloading report',
                confirmButtonColor: '#000000'
            });
        }
    }
</script>